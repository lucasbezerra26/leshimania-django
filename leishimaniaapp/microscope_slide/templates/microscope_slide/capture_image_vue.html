{% extends "base.html" %}

{% block page %}
  <li class="breadcrumb-item"><a href="{% url 'add_microscope_slide' %}">Lâminas</a></li>
  <li class="breadcrumb-item"><a href="{% url 'list_microscope_image' slide_id %}">{{ slide.slide_name }}</a></li>
  <li class="breadcrumb-item active">Adicionar Imagem</li>
{% endblock %}

{% block css %}
  <style>
      .data-console {
          width: 100%;
          min-height: 130px;
          overflow-y: scroll;
          border: 1px solid #ccc;
      }
  </style>
{% endblock %}

{% block content %}
  <section class="section" id="vue-app">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title text-center">Classificação de Imagens de LV Humana</h5>

            <div class="row justify-content-center">
              <div class="col-lg-6">
                <div class="contentarea">
                  <div class="camera h-100 w-100">
                    <video ref="video" class="h-100 w-100">Video não disponível.</video>
                    <button @click="takePicture" class="d-none">Take photo</button>
                  </div>
                  <canvas ref="canvas" class="h-100 w-100 d-none"></canvas>
                  <div class="text-center mt-3 pre-capture">
                    <label for="cameraSelect" class="form-label">Selecionar Câmera</label>
                    <select v-model="selectedCamera" @change="changeCamera" class="form-control">
                      <option v-for="(device, index) in videoDevices" :key="index" :value="device.deviceId"
                              v-text="device.label || `Câmera ${index + 1}`">
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-center align-content-center w-100">
              <textarea class="data-console w-50" readonly v-model="receivedData"></textarea>
            </div>
            <br><br>

            <div class="text-center">
              <div v-if="isInicio">
                <button class="btn btn-primary pre-capture m-2" @click="connectSerialPort">Iniciar</button>
                <a href="{% url 'list_microscope_image' slide_id %}" class="btn btn-secondary m-2">Voltar</a>
              </div>
              <div v-else>
                <div v-if="showMenu">
                  <button class="btn btn-primary pre-capture m-2" @click="writeSerial('configurar')">Configurar</button>
                  <button class="btn btn-success pre-capture m-2" @click="startCapture">Capturar</button>
                  <button class="btn btn-warning pre-capture m-2" @click="writeSerial('testar')">Testar</button>

                  <div class="mt-3">
                    <h5>Controle de Passos:</h5>
                    <button class="btn btn-info m-2" @click="writeSerial('positivo')">Positivo</button>
                    <button class="btn btn-danger m-2" @click="writeSerial('negativo')">Negativo</button>
                    <button class="btn btn-secondary m-2" @click="writeSerial('ok')">OK</button>
                  </div>

                  <div class="mt-3">
                    <label>
                      <input type="checkbox" v-model="saveLocal" />
                      Salvar localmente
                    </label>
                  </div>
                </div>

                <button class="btn btn-danger capture-started m-2" @click="disconnectSerialPort">Finalizar</button>
                <a href="{% url 'list_microscope_image' slide_id %}" class="btn btn-secondary">Voltar</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block javascript %}
  <!-- Adicionando Vue.js via CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
      document.addEventListener("DOMContentLoaded", () => {
          const app = Vue.createApp({
              data() {
                  return {
                      videoDevices: [],
                      selectedCamera: null,
                      streaming: false,
                      currentStream: null,
                      port: null,
                      reader: null,
                      receivedData: '',
                      isCameraStarted: false,
                      width: 1280,
                      height: 720,
                      isInicio: true,
                      showMenu: false,
                      saveLocal: false, // Flag para salvar localmente ou no servidor
                      awaitingCapture: false, // Estado aguardando confirmação de captura
                  };
              },
              mounted() {
                  this.getCameras();
              },
              methods: {
                  async getCameras() {
                      const devices = await navigator.mediaDevices.enumerateDevices();
                      this.videoDevices = devices.filter(device => device.kind === 'videoinput');
                      if (this.videoDevices.length > 0) {
                          this.selectedCamera = this.videoDevices[0].deviceId;
                          this.startCamera();
                      }
                  },
                  async startCamera() {
                      if (this.currentStream) {
                          this.currentStream.getTracks().forEach(track => track.stop());
                      }
                      try {
                          this.currentStream = await navigator.mediaDevices.getUserMedia({
                              video: {deviceId: this.selectedCamera ? {exact: this.selectedCamera} : undefined},
                          });
                          const videoElement = this.$refs.video;
                          videoElement.srcObject = this.currentStream;
                          videoElement.play();
                          this.streaming = true;
                      } catch (error) {
                          console.error('Erro ao acessar a câmera:', error);
                      }
                  },
                  async changeCamera() {
                      this.startCamera();
                  },
                  async connectSerialPort() {
                      try {
                          this.port = await navigator.serial.requestPort();
                          await this.port.open({baudRate: 9600});
                          this.isInicio = false;
                          this.readSerialData();
                      } catch (error) {
                          console.error('Erro ao conectar à porta serial:', error);
                      }
                  },
                  async writeSerial(data) {
                    try {
                      const writer = this.port.writable.getWriter();
                      const encoder = new TextEncoder();
                      const encodedData = encoder.encode(data + '\n'); // Adiciona '\n' para indicar o final do comando
                      await writer.write(encodedData);
                      writer.releaseLock();
                    } catch (error) {
                      console.error("Erro ao escrever na porta serial:", error);
                    }
                  },
                  async readSerialData() {
                      this.reader = this.port.readable.getReader();
                      try {
                          while (true) {
                              const {value, done} = await this.reader.read();
                              if (done) break;
                              const incomingData = new TextDecoder().decode(value);
                              this.receivedData += incomingData;
                              console.log('Dados recebidos:', this.receivedData);

                              if (this.receivedData.includes("Digite 'capturar' para começar a captura")) {
                                  this.showMenu = true;
                                  this.receivedData = '';
                                  this.awaitingCapture = false;
                              }

                              if (this.awaitingCapture && incomingData.includes('0')) {
                                  // Se a mensagem '1' for recebida, significa que a captura está confirmada
                                  console.log("Confirmação de captura recebida, iniciando captura.");
                                  this.takePicture();
                                  this.writeSerial(1)


                              }
                          }
                      } catch (error) {
                          console.error('Erro ao ler dados da porta serial:', error);
                      } finally {
                          this.reader.releaseLock();
                      }
                  },
                  async startCapture() {
                      this.awaitingCapture = true;
                      this.writeSerial('capturar')
                  },
                  takePicture() {
                      const canvas = this.$refs.canvas;
                      const context = canvas.getContext('2d');
                      if (this.width && this.height) {
                          canvas.width = this.width;
                          canvas.height = this.height;
                          context.drawImage(this.$refs.video, 0, 0, this.width, this.height);

                          // Convertendo o canvas para um blob
                          canvas.toBlob(blob => {
                              if (this.saveLocal) {
                                  // Salvar localmente
                                  const downloadLink = document.createElement('a');
                                  downloadLink.href = URL.createObjectURL(blob);
                                  downloadLink.download = 'captured_image.png'; // Nome do arquivo ao salvar
                                  document.body.appendChild(downloadLink);
                                  downloadLink.click();
                                  document.body.removeChild(downloadLink);
                                  URL.revokeObjectURL(downloadLink.href); // Liberar a memória
                              } else {
                                  // Enviar para o servidor
                                  const formData = new FormData();
                                  formData.append("file", blob, "image.png");

                                  fetch(".", {
                                      method: "POST",
                                      body: formData,
                                  })
                                  .then(response => response.json())
                                  .then(data => console.log(data))
                                  .catch(error => console.error('Erro:', error));
                              }

                              // Após captura, envia o comando "1" para indicar que a captura foi concluída
                              this.writeSerial('1');
                          }, 'image/png');
                      }
                  },
                  async disconnectSerialPort() {
                      this.isInicio = true;
                      if (this.reader) {
                          await this.reader.cancel();
                          await this.reader.releaseLock();
                      }
                      if (this.port) {
                          await this.port.close();
                      }
                  },
              },
          }).mount('#vue-app');
      });
  </script>
{% endblock %}
